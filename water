<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eau de Paris ‚Äî Refill & Qualit√©</title>

  <!-- PWA bits (you already have these files) -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0c3c88">
  <link rel="icon" sizes="192x192" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    :root{--blue:#0c3c88;--cyan:#29a3d9;--bg:#f6f9fc;--ink:#14213d;--muted:#6b7280;--good:#16a34a;--warn:#d97706;--bad:#dc2626}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;color:var(--ink);background:var(--bg)}
    header{position:sticky;top:0;z-index:20;background:white;border-bottom:1px solid #e5e7eb}
    .wrap{max-width:1100px;margin:0 auto;padding:12px 16px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--blue),var(--cyan));display:grid;place-items:center;color:white;font-weight:700}
    h1{font-size:18px;margin:0}
    .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:16px;margin:16px 0}
    @media (max-width:900px){.grid{grid-template-columns:1fr;}}
    .card{background:white;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .card h2{font-size:18px;margin:0 0 4px}
    .pad{padding:14px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    input[type=text],select{padding:10px 12px;border:1px solid #d1d5db;border-radius:12px;flex:1;min-width:200px}
    button{padding:10px 14px;border:none;border-radius:12px;background:var(--blue);color:white;font-weight:600;cursor:pointer}
    button.secondary{background:#eef2ff;color:var(--blue)}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;background:#eef2ff;color:var(--blue);margin-right:6px}
    .badge.good{background:#ecfdf5;color:var(--good)} .badge.warn{background:#fffbeb;color:var(--warn)} .badge.bad{background:#fef2f2;color:var(--bad)}
    #map{height:520px;border-radius:16px}
    .row{display:flex;gap:10px;align-items:center}
    .list{display:grid;gap:10px;margin-top:8px}
    .item{padding:10px;border:1px dashed #e5e7eb;border-radius:12px;background:white}
    .muted{color:var(--muted);font-size:13px}
    .divider{height:1px;background:#eef2f7;margin:12px 0}
    footer{padding:20px;color:var(--muted);text-align:center}
    .chip{padding:6px 10px;border:1px solid #d1d5db;border-radius:999px;background:white;cursor:pointer}
    .chip.active{background:#e0f2fe;border-color:#7dd3fc}
    .legend{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
  <header>
    <div class="wrap brand">
      <div class="logo">EP</div>
      <div>
        <h1>Eau de Paris ‚Äî Refill & Qualit√©</h1>
        <div class="muted">Carte des fontaines, qualit√© par adresse, alertes & signalements</div>
      </div>
      <div style="margin-left:auto" class="row">
        <button class="secondary" onclick="geoLocate()">üìç Ma position</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="grid">
      <div class="card pad">
        <h2>Qualit√© de l'eau par adresse</h2>
        <div class="controls">
          <input id="addr" type="text" placeholder="Ex: 5 Avenue de l'Op√©ra, 75001 Paris" />
          <button onclick="checkQuality()">V√©rifier</button>
        </div>
        <div id="qualityResult" style="margin-top:10px"></div>
        <div class="divider"></div>
        <div class="legend">
          <span class="badge good">Excellent</span>
          <span class="badge warn">Attention</span>
          <span class="badge bad">Avertissement</span>
          <span class="muted">Duret√©, Nitrates, Chlore, pH, Conductivit√©</span>
        </div>
      </div>

      <div class="card pad">
        <h2>Alertes & Travaux</h2>
        <div class="list" id="alerts"></div>
      </div>
    </section>

    <section class="card pad">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div>
          <h2>Carte des points d'eau</h2>
          <div class="muted">Filtrer par type et accessibilit√©. Cliquez sur un point pour les d√©tails.</div>
        </div>
        <div class="controls" style="justify-content:flex-end">
          <button class="chip active" data-filter="all" onclick="setFilter(event)">Tous</button>
          <button class="chip" data-filter="still" onclick="setFilter(event)">Eau plate</button>
          <button class="chip" data-filter="sparkling" onclick="setFilter(event)">P√©tillante</button>
          <button class="chip" data-filter="partner" onclick="setFilter(event)">Partenaires</button>
          <label class="chip" style="display:flex;gap:8px;align-items:center">
            <input type="checkbox" id="accOnly" onchange="refreshMarkers()"/> Accessible ‚ôø
          </label>
        </div>
      </div>
      <div id="map" class="pad" style="padding:0;margin-top:10px"></div>
    </section>

    <section class="grid">
      <div class="card pad">
        <h2>Signaler un probl√®me</h2>
        <div class="controls">
          <select id="issueType">
            <option>Choisir un type‚Ä¶</option>
            <option>Pas d'eau</option>
            <option>Robinet cass√©</option>
            <option>Go√ªt / odeur</option>
            <option>Vandalisme</option>
          </select>
          <input id="issueNote" type="text" placeholder="Ajoutez une note (facultatif)" />
          <button onclick="submitIssue()">Envoyer</button>
        </div>
        <div id="issueMsg" class="muted" style="margin-top:8px"></div>
      </div>

      <div class="card pad">
        <h2>√Ä propos</h2>
        <p>D√©mo sans suivi. Les donn√©es qualit√©/fontaines ci-dessous sont <em>d√©monstratives</em>. Branchez l‚ÄôOpen Data d‚ÄôEau de Paris pour la prod.</p>
        <div class="list" id="issuesList"></div>
      </div>
    </section>
  </main>

  <footer>
    Fait avec üíß ‚Äî Prototype public service ‚Ä¢ Map ¬© OpenStreetMap contributors
  </footer>

  <script>
    // Register service worker (already in your repo as sw.js)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(()=>{});
      });
    }

    // Demo datasets
    const fountains = [
      {id:1,type:'still',name:'Square du Temple',lat:48.86661,lng:2.36242,access:true,hours:'6h‚Äì22h',last_service:'2025-08-20'},
      {id:2,type:'sparkling',name:'Square √âdouard-VII',lat:48.87177,lng:2.32996,access:false,hours:'24/7',last_service:'2025-08-01'},
      {id:3,type:'partner',name:'Caf√© La Carafe',lat:48.85361,lng:2.34893,access:true,hours:'8h‚Äì20h',last_service:'2025-07-10'},
      {id:4,type:'still',name:'Jardin des Plantes',lat:48.84352,lng:2.35701,access:true,hours:'7h‚Äì21h',last_service:'2025-08-12'},
      {id:5,type:'sparkling',name:'Place de la R√©publique',lat:48.8674,lng:2.3630,access:true,hours:'24/7',last_service:'2025-07-28'}
    ];

    const qualityZones = [
      {id:'75001',name:'1er',center:[48.8625,2.3364],metrics:{hardness:25,nitrates:18,chlorine:0.1,ph:7.6,cond:480,status:'good'},updated:'2025-09-01'},
      {id:'75010',name:'10e',center:[48.8740,2.3570],metrics:{hardness:28,nitrates:24,chlorine:0.15,ph:7.5,cond:520,status:'good'},updated:'2025-09-02'},
      {id:'75011',name:'11e',center:[48.8575,2.3800],metrics:{hardness:32,nitrates:42,chlorine:0.18,ph:7.4,cond:560,status:'warn'},updated:'2025-09-02'},
      {id:'75005',name:'5e',center:[48.8443,2.3499],metrics:{hardness:22,nitrates:12,chlorine:0.08,ph:7.7,cond:450,status:'good'},updated:'2025-09-03'}
    ];

    const alertsData = [
      {id:'a1',zone:'10e',title:'Travaux r√©seau',body:'Restriction de d√©bit rue du Faubourg Saint-Martin (10e) ‚Äî 9‚Äì11 sept.',sev:'info'},
      {id:'a2',zone:'11e',title:'Avis de qualit√©',body:"Hausse temporaire de la conductivit√© (11e). L'eau reste potable.",sev:'low'},
      {id:'a3',zone:'5e',title:'Interruption',body:'Arr√™t de la fontaine c√¥t√© Jardin alpin ‚Äî 7 sept., 10h‚Äì16h.',sev:'high'}
    ];

    // Helpers
    const qEl = (sel)=>document.querySelector(sel);
    const el = (tag,cls,txt)=>{const n=document.createElement(tag); if(cls) n.className=cls; if(txt) n.textContent=txt; return n;}

    // Alerts render
    function renderAlerts(){
      const root = qEl('#alerts'); root.innerHTML='';
      alertsData.forEach(a=>{
        const box = el('div','item');
        const badge = el('span','badge '+(a.sev==='high'?'bad':a.sev==='low'?'warn':''), a.title);
        const p = el('div','muted', a.body + ' ¬∑ Zone: '+a.zone);
        box.appendChild(badge); box.appendChild(p); root.appendChild(box);
      });
    }

    // Map
    const map = L.map('map', { zoomControl:true, attributionControl:true }).setView([48.8566,2.3522], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(map);

    const icons = {
      still: L.divIcon({className:'',html:'<div style="background:#0ea5e9;color:white;padding:6px 8px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.2)">üíß</div>',iconSize:[24,24],iconAnchor:[12,12]}),
      sparkling: L.divIcon({className:'',html:'<div style="background:#22c55e;color:white;padding:6px 8px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.2)">‚ú®</div>',iconSize:[24,24],iconAnchor:[12,12]}),
      partner: L.divIcon({className:'',html:'<div style="background:#6366f1;color:white;padding:6px 8px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.2)">ü§ù</div>',iconSize:[24,24],iconAnchor:[12,12]})
    }

    let markers=[]; let currentFilter='all';

    function refreshMarkers(){
      markers.forEach(m=>map.removeLayer(m)); markers = [];
      const accOnly = qEl('#accOnly').checked;
      fountains.filter(f=> (currentFilter==='all'|| f.type===currentFilter) && (!accOnly || f.access)).forEach(f=>{
        const m = L.marker([f.lat,f.lng], {icon: icons[f.type]});
        m.bindPopup(`<b>${f.name}</b><br/>Type: ${labelType(f.type)}<br/>Accessibilit√©: ${f.access?'Oui':'Non'}<br/>Heures: ${f.hours}<br/>Dernier entretien: ${f.last_service}<div style="margin-top:6px"><a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination=${f.lat},${f.lng}"><button>Itin√©raire</button></a> <button class="secondary" onclick="prefillIssue(${f.id})">Signaler</button></div>`);
        m.addTo(map); markers.push(m);
      });
    }

    function labelType(t){ return t==='still'?'Eau plate': t==='sparkling'?'P√©tillante':'Partenaire'; }

    function setFilter(e){
      document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      e.target.classList.add('active');
      currentFilter = e.target.dataset.filter; refreshMarkers();
    }

    function prefillIssue(fid){
      qEl('#issueType').value = "Pas d'eau";
      qEl('#issueNote').value = `Probl√®me √† la fontaine #${fid}`;
      qEl('#issueMsg').textContent = 'Formulaire pr√©rempli. Ajoutez des d√©tails et envoyez.';
    }

    function geoLocate(){
      if(!navigator.geolocation){alert('G√©olocalisation indisponible');return;}
      navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude,longitude} = pos.coords;
        map.setView([latitude,longitude], 15);
        L.circleMarker([latitude,longitude],{radius:8,weight:2,color:'#2563eb',fillColor:'#93c5fd',fillOpacity:.6}).addTo(map).bindPopup('Vous √™tes ici');
      },()=>alert('Position refus√©e'));
    }

    async function checkQuality(){
      const q = qEl('#addr').value.trim();
      const out = qEl('#qualityResult'); out.innerHTML='Recherche‚Ä¶';
      try{
        const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`);
        const results = await r.json();
        if(!results.length){ out.textContent = 'Adresse introuvable.'; return; }
        const { lat, lon, display_name } = results[0];
        const nearest = qualityZones.map(z=>({z, d: haversine([+lat,+lon], z.center)})).sort((a,b)=>a.d-b.d)[0].z;
        out.innerHTML = renderQuality(nearest, display_name);
        map.setView([+lat,+lon], 15);
        L.marker([+lat,+lon]).addTo(map).bindPopup('Adresse').openPopup();
      }catch(e){ out.textContent='Erreur r√©seau.'; }
    }

    function renderQuality(zone, addr){
      const status = zone.metrics.status;
      const badgeCls = status==='good'?'good':status==='warn'?'warn':'bad';
      const verdict = status==='good'?'Excellent':status==='warn'?'Attention':'Avertissement';
      return `
        <div class="item">
          <div class="row" style="justify-content:space-between;align-items:baseline">
            <div><span class="badge ${badgeCls}">${verdict}</span> <strong>${addr}</strong></div>
            <div class="muted">Maj: ${zone.updated} ¬∑ Zone prox.: ${zone.name}</div>
          </div>
          <div class="list">
            <div>üíß Duret√©: <strong>${zone.metrics.hardness}</strong> ¬∞f</div>
            <div>üß™ Nitrates: <strong>${zone.metrics.nitrates}</strong> mg/L</div>
            <div>üõ°Ô∏è Chlore libre: <strong>${zone.metrics.chlorine}</strong> mg/L</div>
            <div>‚öñÔ∏è pH: <strong>${zone.metrics.ph}</strong></div>
            <div>üîå Conductivit√©: <strong>${zone.metrics.cond}</strong> ¬µS/cm</div>
          </div>
          <div class="muted" style="margin-top:6px">* Donn√©es d√©mo ‚Äî remplacez par l'API qualit√© en prod.</div>
        </div>`;
    }

    function haversine(a,b){
      const toRad = d=>d*Math.PI/180; const R=6371;
      const dLat = toRad(b[0]-a[0]); const dLon = toRad(b[1]-a[1]);
      const lat1=toRad(a[0]); const lat2=toRad(b[0]);
      const x = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(x));
    }

    function submitIssue(){
      const type = qEl('#issueType').value; const note = qEl('#issueNote').value.trim();
      if(!type || type.startsWith('Choisir')){ alert('Choisissez un type'); return; }
      const id = 'ISS-'+Math.random().toString(36).slice(2,8).toUpperCase();
      const payload = {id,type,note,date:new Date().toISOString()};
      const all = JSON.parse(localStorage.getItem('issues')||'[]'); all.unshift(payload);
      localStorage.setItem('issues', JSON.stringify(all));
      qEl('#issueMsg').textContent = `Signalement envoy√© (#${id}). Merci !`; qEl('#issueType').value='Choisir un type‚Ä¶'; qEl('#issueNote').value='';
      renderIssues();
    }

    function renderIssues(){
      const root = qEl('#issuesList'); root.innerHTML = '<div class="muted">Signalements r√©cents (local)</div>';
      const all = JSON.parse(localStorage.getItem('issues')||'[]');
      all.slice(0,6).forEach(i=>{
        const it = el('div','item'); it.innerHTML = `<strong>${i.id}</strong> ‚Äî ${i.type}<div class="muted">${new Date(i.date).toLocaleString()} ¬∑ ${i.note||'‚Äî'}</div>`; root.appendChild(it);
      });
    }

    // boot
    renderAlerts(); refreshMarkers(); renderIssues();
  </script>
</body>
</html>
